# MSU Life PWA — Build Log

## Entry 001 — Development Environment Setup

**Date:** 2026-02-11
**Environment:** WSL2 (Ubuntu 22.04)

### System Configuration

* Node.js: v20.20.0
* npm: 10.8.2
* Git: 2.34.1
* Development directory: `/home/david/msu-life`

### Git Configuration

Configured global Git identity:

```
git config --global user.name "David Alonso"
git config --global user.email "davidalonsog97@gmail.com"
```

SSH authentication configured:

* Generated ED25519 key
* Added public key to GitHub
* Verified connection using:

```
ssh -T git@github.com
```

Authentication confirmed successful.

---

## Entry 002 — Project Initialization

Created new Next.js project using:

```
npx create-next-app@latest . --ts --eslint --tailwind --app --src-dir --import-alias "@/*"
```

Options:

* TypeScript enabled
* App Router enabled
* Tailwind enabled
* React Compiler disabled (for stability)

Verified local server:

```
npm run dev
```

Local app successfully running at:

```
http://localhost:3000
```

---

## Entry 003 — Version Control & GitHub Integration

Initialized Git repository:

```
git init
git add .
git commit -m "chore: initial Next.js setup"
```

Created GitHub repository:

* Name: `msu-life`
* Visibility: Public
* Empty repository (no README)

Connected local repo to GitHub via SSH:

```
git remote set-url origin git@github.com:mrdeived/msu-life.git
git push -u origin main
```

Push successful. Branch `main` tracking remote.

---

## Entry 004 — Railway Deployment (Initial)

Created Railway project:

* Connected GitHub repository
* Automatic build detected (Next.js)

Verified:

* Successful production deployment
* Public URL accessible
* Default Next.js page loads correctly

Pipeline confirmed:
GitHub → Railway → Production

---

## Entry 005 — PostgreSQL Integration

Added PostgreSQL service to Railway project.

Configured environment variable:

* `DATABASE_URL` linked to Postgres service
* Confirmed variable available in Web service

---

## Entry 006 — Prisma Setup

Installed Prisma:

```
npm install prisma @prisma/client
```

Initial version (v7) caused schema conflict.
Downgraded to stable v6:

```
npm remove prisma @prisma/client
npm install prisma@6 @prisma/client@6
```

Removed `prisma.config.ts` to restore `.env` loading behavior.

Configured `.env` with Railway `DATABASE_URL`.

---

## Entry 007 — Initial Database Schema & Migration

Created minimal schema:

```prisma
model HealthCheck {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
}
```

Executed migration:

```
npx prisma migrate dev --name init
```

Migration applied successfully to Railway Postgres.
Prisma Client generated.

---

## Entry 008 — Backend API Verification

Created endpoint:

`src/app/api/health/route.ts`

Functionality:

* Inserts record into `HealthCheck`
* Returns `{ ok: true }`

Verified:

* Local endpoint working
* Production endpoint working:

  * `/api/health` returns `{ ok: true }`
  * Database write confirmed in production

System confirmed operational end-to-end:
Frontend → API → Prisma → Railway Postgres → Production

---

## Current System State

The system now has:

* Next.js App Router application
* GitHub repository with SSH authentication
* Continuous deployment via Railway
* PostgreSQL hosted in Railway
* Prisma migrations working
* API writing to production database
* Local and production environments aligned

Development foundation complete.

---

## Entry 009 — User & EmailOtp Schema (V1 Auth Start)

**Date:** 2026-02-11

### Summary

- Added `GlobalRole` enum (`STUDENT`, `SUPERUSER`)
- Added `User` model (cuid PK, unique email, optional name/avatarUrl, role default STUDENT, isActive/isBanned flags, timestamps)
- Added `EmailOtp` model (cuid PK, email indexed, hashed code, expiry, single-use tracking via `usedAt`, optional relation to User by email)

### Commands

```
npx prisma migrate dev --name add_user_and_emailotp
```

Migration applied: `20260211062919_add_user_and_emailotp`
Prisma Client regenerated (v6.19.2).

### Verification

- `npx next build` — compiled successfully
- `/api/health` — returns `{"ok":true}`, DB write confirmed
- No breakage to existing HealthCheck model

### Notes

- No endpoints or route handlers implemented in this step
- `org_admin` role deferred to org membership phase
- EmailOtp FK references User.email (cascade on update, restrict on delete)

---

## Entry 010 — Fix EmailOtp FK (Allow OTP Before User)

**Date:** 2026-02-11

### Summary

- Removed `EmailOtp -> User.email` FK constraint to allow OTP creation before User exists (required for NDUS OTP flow)
- Removed `otps` relation field from `User` model and `user` relation field from `EmailOtp` model

### Commands

```
npx prisma migrate dev --name fix_emailotp_fk
```

Migration applied: `20260211064357_fix_emailotp_fk`
Prisma Client regenerated (v6.19.2).

### Verification

- `npx next build` — compiled successfully
- `/api/health` — returns `{"ok":true}`
- `scripts/test-otp-insert.ts` — inserts successfully (`✅ Inserted OTP`)

### Notes

- User creation will occur during OTP verification step (future endpoint)

---

## Entry 011 — Auth: Request OTP Endpoint (NDUS Restricted)

**Date:** 2026-02-11

### Summary

- Added `POST /api/auth/request-otp` route handler
- Validates email with Zod and restricts domain via `ALLOWED_EMAIL_DOMAIN` (default `ndus.edu`)
- Generates 6-digit OTP (leading zeros preserved), hashes with sha256 (`email:otp:pepper`), stores in `EmailOtp` with configurable expiry (`OTP_TTL_SECONDS`, default 600)
- Dev-only logging of OTP to server console; no OTP returned in API response
- Rate limiting: max 5 OTPs per email in 10-minute window (DB-based, returns 429)
- Created `src/lib/otp.ts` (generate + hash helpers) and `src/lib/validation.ts` (Zod schema)
- Added `.env.example` with all env vars documented

### Files Added

- `src/app/api/auth/request-otp/route.ts`
- `src/lib/otp.ts`
- `src/lib/validation.ts`
- `.env.example`

### Commands

```
npm install zod
npx next build
curl tests (200, 403, 400 status codes verified)
```

### Verification

- `npx next build` — compiled successfully, route listed as `ƒ /api/auth/request-otp`
- Valid NDUS email → `200 {"ok":true}`, OTP logged in dev console
- Non-NDUS email → `403 {"error":"Email domain not allowed"}`
- Invalid JSON → `400 {"error":"Invalid JSON"}`
- `/api/health` — still returns `{"ok":true}`

### Notes

- Email provider integration deferred (Resend/SendGrid planned)
- Zod was already in dependency tree (no new install needed)

---

## Entry 012 — Stabilize Prisma Client (Singleton)

**Date:** 2026-02-11

### Summary

- Added Prisma singleton in `src/lib/prisma.ts` to avoid exhausting DB connections in Next.js
- Updated `request-otp` route to use shared prisma instance
- Updated `health` route to use shared prisma instance

### Commands

```
npx next build
curl tests
```

### Verification

- `/api/auth/request-otp` — still returns `200 {"ok":true}` for NDUS emails
- `/api/health` — still returns `{"ok":true}`

---

## Entry 013 — Auth: Verify OTP Endpoint (Create User)

**Date:** 2026-02-11

### Summary

- Added `POST /api/auth/verify-otp` route handler
- Validates email + 6-digit code with Zod, enforces NDUS domain
- Verifies OTP by hash match + expiry + single-use (`usedAt` null guard)
- Uses `prisma.$transaction` to atomically mark OTP used and upsert User
- Creates User with role `STUDENT` on first successful verification
- Returns `{ ok: true, user: { id, email, role } }`

### Files Added/Edited

- `src/app/api/auth/verify-otp/route.ts` (new)
- `src/lib/validation.ts` (added `verifyOtpSchema`)

### Commands

```
npx next build
curl request-otp + verify-otp tests
```

### Verification

- Valid code → `200 {"ok":true,"user":{"id":"...","email":"verifytest3@ndus.edu","role":"STUDENT"}}`
- Reuse same code → `401 {"error":"Invalid or expired code"}`
- Wrong code → `401 {"error":"Invalid or expired code"}`
- `/api/health` — still returns `{"ok":true}`

### Notes

- Sessions/cookies deferred to next step

---

## Entry 014 — Auth: Session Cookie (me + logout)

**Date:** 2026-02-11

### Summary

- Added signed HttpOnly session cookie on `verify-otp` success
- Cookie format: `base64url(payload).base64url(hmac-sha256)`, cookie name `msu_life_session`
- Payload: `{ uid, email, role, exp }` with configurable TTL (default 30 days)
- Added `GET /api/auth/me` — returns user from DB if session valid, checks `isActive`/`isBanned`
- Added `POST /api/auth/logout` — clears cookie with `Max-Age=0`
- Cookie flags: `HttpOnly; SameSite=Lax; Path=/`; `Secure` added in production only
- Implemented `src/lib/session.ts` (sign/verify, cookie header helpers) and `src/lib/auth.ts` (parse cookie from request)
- Updated `.env.example` with `SESSION_SECRET` and `SESSION_TTL_SECONDS`

### Files Added/Edited

- `src/lib/session.ts` (new)
- `src/lib/auth.ts` (new)
- `src/app/api/auth/me/route.ts` (new)
- `src/app/api/auth/logout/route.ts` (new)
- `src/app/api/auth/verify-otp/route.ts` (edited — sets cookie on success)
- `.env.example` (edited)

### Commands

```
npx next build
curl verify-otp (capture Set-Cookie), me, logout tests
```

### Verification

- `verify-otp` → `200` with `Set-Cookie: msu_life_session=...; HttpOnly; SameSite=Lax; Path=/; Max-Age=2592000`
- `/api/auth/me` with cookie → `200 {"ok":true,"user":{"id":"...","email":"sessiontest@ndus.edu","role":"STUDENT"}}`
- `/api/auth/logout` → `200 {"ok":true}` with `Set-Cookie: msu_life_session=; Max-Age=0`
- `/api/auth/me` without cookie → `401 {"error":"Not authenticated"}`
- `/api/health` — still returns `{"ok":true}`

### Notes

- UI protected routes deferred to next step
- `SESSION_SECRET` must be set in Railway env vars before deploying

---

## Entry 015 — UI: Login + Protected Home (V1 Auth UI)

### Date

2026-02-11

### Summary

- Added /login UI for NDUS OTP flow (request + verify)
- Added protected /home page using session cookie verification on server
- Added logout button to clear session and redirect to login

### Files Changed

- Added: `src/lib/requireAuth.ts` — server-side auth helper using `cookies()` + `verifySession()`
- Added: `src/app/login/page.tsx` — two-step OTP login (email → code)
- Added: `src/app/home/page.tsx` — server-protected home page
- Added: `src/components/LogoutButton.tsx` — client component for logout

### Commands

```
npx next build
```

### Verification

- /home redirects to /login when unauthenticated
- OTP login works end-to-end and creates session cookie
- Logout clears cookie and /home becomes inaccessible
- /api/health still OK

### Notes

- Styling minimal; feed UI deferred
- No (authed) route group — using requireAuth() directly in server pages for simplicity
- cookies() is read-only in Server Components; stale cookies cleared on next login

---

## Entry 016 — Auth: Debug OTP Return (Controlled)

### Date

2026-02-11

### Summary

- Added guarded debug mode to return OTP in API response for testing without email provider
- Default production behavior unchanged (returns only {ok:true})

### Env

- `OTP_DEBUG_RETURN_CODE` (default false)

### Commands

```
npx next build
curl POST /api/auth/request-otp (verify debug response only when enabled)
```

### Verification

- Production: when `OTP_DEBUG_RETURN_CODE=true`, request-otp returns `debug.code` and verify-otp succeeds and sets cookie
- Production: when `OTP_DEBUG_RETURN_CODE=false`, request-otp returns only `{ok:true}`

---

## Entry 017 — Email: Resend OTP Delivery

### Date

2026-02-12

### Summary

- Integrated Resend to deliver OTP codes by email in production
- request-otp now sends email after storing OTP (production only)

### Env

- `RESEND_API_KEY`
- `RESEND_FROM`

### Commands

```
npm install resend
npx next build
```

### Verification

- Dev flow unchanged; production sends OTP email and verify-otp works

---

## Entry 018 — Auth: Demo OTP Bypass (000000)

### Date

2026-02-12

### Summary

- Added demo bypass to accept code "000000" on verify-otp when OTP_DEMO_BYPASS=true
- Still enforces ALLOWED_EMAIL_DOMAIN
- Normal OTP verification path unchanged when bypass disabled

### Commands

```
npx next build
curl verify-otp + me tests
```

### Verification

- OTP_DEMO_BYPASS=false → 000000 rejected
- OTP_DEMO_BYPASS=true → 000000 accepted, session cookie set, /me ok

---

## Entry 019 — UI: Home Dashboard (Mock Data)

### Date

2026-02-12

### Summary

- Replaced minimal /home view with a dashboard-style UI using mock data
- Kept server-side route protection intact
- Added mock data module for upcoming events + announcements

### Commands

```
npx next build
```

### Verification

- /home redirects when unauthenticated
- Logged-in users see dashboard with email + role + sections
- Logout still works

---

## Entry 020 — UI: MSU Branding Colors (Red/White/Green)

### Date

2026-02-12

### Summary

- Introduced MSU color tokens (red/white/green) via CSS variables + Tailwind @theme
- Updated Home top bar to MSU red with green bottom accent
- Updated section headings to MSU red
- Updated Logout button for white-on-red header
- Updated Login page buttons/inputs from blue to MSU red

### Commands

```
npx next build
```

### Verification

- Home + Login render correctly on mobile/desktop
- No auth logic changes

---

## Entry 021 — PWA: Minimal Offline Shell

### Date

2026-02-12

### Summary

- Added PWA manifest via `src/app/manifest.ts` (Next.js metadata route)
- Added placeholder icons (192px + 512px solid MSU red PNGs)
- Added handwritten service worker (`public/sw.js`) with offline fallback
- Added `/offline` page with retry button
- Service worker registered from layout via client component
- Updated layout metadata to "MSU Life"

### Commands

```
npx next build
```

### Verification

- manifest loads at /manifest.webmanifest
- offline fallback works when network disconnected

---

## Entry 023 — Data: Events + Announcements (DB-backed, Read-only)

### Date

2026-02-12

### Summary

- Added Event and Announcement models to Prisma schema
- Created read-only GET endpoints for events and announcements
- Replaced mock dashboard data on /home with Prisma queries
- Added optional demo seed script

### Commands

```
npx prisma migrate dev --name add_events_and_announcements
npx next build
```

### Verification

- /home renders real DB data for Upcoming + Announcements (no mock), protected route unchanged

---

## Entry 024 — PWA: iOS Standalone Offline Fallback Fix

### Date

2026-02-12

### Summary

- Updated service worker navigation detection to support iOS standalone document requests
- Navigation fallback now triggers for `request.mode === "navigate"` OR `request.destination === "document"`
- Added static `public/offline.html` (zero JS dependencies) as the cached fallback
- Bumped service worker cache version to v3 to force update

### Commands

```
npx next build
```

### Verification

- iPhone Home Screen launch in Airplane Mode shows offline.html instead of client-side exception

---

## Entry 025 — UI: Events Feed Page (DB-backed)

### Date

2026-02-12

### Summary

- Added server-protected /feed page that lists upcoming published events from Prisma
- Implemented MSU-branded card UI with links to /event/[id]
- Wired Home "Browse Events" quick action to /feed

### Commands

```
npx next build
```

### Verification

- /feed requires auth and displays DB events (or empty state)

---

## Entry 026 — UI: Event Detail Page (DB-backed)

### Date

2026-02-12

### Summary

- Added server-protected /event/[id] page that loads a published event from Prisma
- Implemented MSU-branded detail layout with back navigation to /feed
- /feed cards already link to /event/[id]

### Commands

```
npx next build
```

### Verification

- Clicking an event in /feed opens /event/[id] and renders DB data (no mock)

---

## Entry 027 — Feature: Event Attendance (Attend/Unattend)

### Date

2026-02-12

### Summary

- Added EventAttendance model with unique (userId, eventId)
- Implemented attend/unattend API routes for events
- Updated /event/[id] to show attendee count and toggle attend button

### Commands

```
npx prisma migrate dev --name add_event_attendance
npx next build
```

### Verification

- Logged-in user can attend/unattend an event and attendee count updates

---

## Entry 028 — Feature: Event Bookmarks (Save/Unsave)

### Date

2026-02-12

### Summary

- Added EventBookmark model with unique (userId, eventId)
- Implemented bookmark/unbookmark API routes for events
- Updated /event/[id] to show bookmark count and toggle button

### Commands

```
npx prisma migrate dev --name add_event_bookmarks
npx next build
```

### Verification

- Logged-in user can bookmark/unbookmark an event and count updates

---

## Entry 029 — UI: Bookmarks Page (DB-backed)

### Date

2026-02-12

### Summary

- Added server-protected /bookmarks page that lists the current user's bookmarked events from Prisma
- Implemented MSU-branded card UI with links to /event/[id]
- Added Home Quick Action link to /bookmarks

### Commands

```
npx next build
```

### Verification

- Bookmarked events appear on /bookmarks and update when toggled

---

## Entry 030 — Feature: Event Likes (Like/Unlike)

### Date

2026-02-12

### Summary

- Added EventLike model with unique (userId, eventId)
- Implemented like/unlike API route for events
- Updated /event/[id] to show like count and toggle button

### Commands

```
npx prisma migrate dev --name add_event_likes
npx next build
```

### Verification

- Logged-in user can like/unlike an event and like count updates

---

## Entry 031 — UI: Instagram-style Event Detail + Unified Action Row

### Date

2026-02-12

### Summary

- Added reusable EventActionRow with icon buttons for Like/Bookmark/Attend using existing APIs
- Updated /event/[id] to use a single unified action row with counts
- Refined event detail layout to a post-style presentation (banner + meta + content)

### Commands

```
npm install lucide-react
npx next build
```

### Verification

- All three toggles work and counts update; UI is cleaner and more "feed/post" styled

---

## Entry 032 — UI: Instagram-style Feed Cards

### Date

2026-02-12

### Summary

- Updated /feed event list to Instagram-style post cards (banner + meta + snippet)
- Preserved server-side auth protection and existing Prisma query
- Cards link to /event/[id] for full details

### Commands

```
npx next build
```

### Verification

- /feed shows post-style cards and navigation to detail works

---

## Entry 033 — UI: Feed Social Counters (Efficient Aggregation)

### Date

2026-02-12

### Summary

- Added per-event like/bookmark/attending counters to /feed cards
- Implemented efficient aggregation via Prisma groupBy (no N+1 queries)

### Commands

```
npx next build
```

### Verification

- /feed shows correct counters matching event interactions

---

## Entry 034 — UI: Feed Inline Actions + Instagram Ratio Banner

### Date

2026-02-12

### Summary

- Updated /feed banner to use Instagram-like 4:5 aspect ratio on sm+ while keeping mobile compact
- Added FeedActionRow with clickable Like/Bookmark/Attend toggles using existing APIs
- Implemented efficient per-user state lookup for feed items (no N+1 queries)

### Commands

```
npx next build
```

### Verification

- Feed icons toggle interactions without navigating; card click still opens detail

---

## Entry 035 — UI: My Events (Attending List)

### Date

2026-02-12

### Summary

- Added server-protected /my-events page listing events the user is attending (Prisma-backed)
- Reused the feed-style post cards and linked to /event/[id]
- Added Home Quick Action link to /my-events

### Commands

```
npx next build
```

### Verification

- Attending events appear on /my-events and update when toggled

---

## Entry 036 — UI: Calendar (Month + List)

### Date

2026-02-12

### Summary

- Added server-protected /calendar with Month and List views
- Month view renders a calendar grid with event pills (links to /event/[id])
- List view groups events by date for quick browsing
- Added Home Quick Action link to /calendar

### Commands

```
npx next build
```

### Verification

- Calendar renders correctly; navigation to event detail works

---
